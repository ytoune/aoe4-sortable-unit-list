<!doctype html>
<html lang="en">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>aoe4 sortable unit list</title>
  <style>
    .tools {
      user-select: none;
    }
    tr {
      margin: 0;
      padding: 0;
      line-height: 2em;
      text-align: start;
      white-space: nowrap;
    }
    tr img {
      max-height: 2em;
    }
    tr span {
      padding-right: 0.5em;
    }
  </style>
  <script src="https://unpkg.com/htm@3/preact/standalone.umd.js"></script>
  <main></main>
  <script>
    const getData = () =>
      fetch('https://data.aoe4world.com/units/all.json').then(r => r.json())
    const formatData = data =>
      Object.entries(Object.groupBy(data, q => q.baseId))
        .map(([i, _]) => {
          /** @type {number[]} */
          const speeds = Array.from(
            new Set(_.flatMap(q => q.movement?.speed ?? [])),
          ).sort()
          /** @type {number[]} */
          const dps = _.flatMap(q =>
            q.weapons.map(w => (w ? w.damage / w.speed : 0)),
          )
          const armors = Array.from(
            new Set(
              _.flatMap(q => q.armor.map(a => (a ? a.type[0] + a.value : 0))),
            ),
          )
          const hashCost = c => {
            const h = k => (c[k] ? k[0] + c[k] : '')
            return [
              h('food'),
              h('wood'),
              h('gold'),
              h('stone'),
              h('oliveoil'),
              `(${c.popcap ?? '_'}/${c.time ?? '_'})`,
              h('vizier'),
            ].join('')
          }
          const sumCost = c => {
            const h = k => c[k] || 0
            return (
              h('food') + h('wood') + h('gold') + h('stone') + h('oliveoil')
            )
          }
          const costs = Array.from(new Set(_.flatMap(q => hashCost(q.costs))))
          const costNum = Array.from(new Set(_.flatMap(q => sumCost(q.costs))))
          return {
            id: _[0].baseId,
            civs: Array.from(
              new Set(_.flatMap(q => q.civs.map(c => c + q.age))),
            ).join(),
            speed: speeds[0] ?? -1,
            dps: dps[0] ?? -1,
            armors: armors.join(),
            costText: costs.join(),
            costs: costNum.sort((q, w) => q - w)[0] ?? 0,
            z_: _,
            z_speed2: speeds.join(),
            z_dps: dps.join(),
          }
        })
        .sort((q, w) => w?.speed - q?.speed)
    const comps = {
      name: ({ item }) => html`
        <a
          href=${`https://aoe4world.com/explorer/units/${item.id}`}
          rel="nofollow noopener noreferrer"
          target="_blank"
        >
          ${item.id}
        </a>
      `,
      icon: ({ item }) =>
        Array.from(new Set(item.z_.map(i => i.icon))).map(
          src => html`
            <img
              key=${src}
              src=${src}
              title=${src.match(/\/([^/]*)(\.[^.]+)$/u)?.[1]}
            />
          `,
        ),
      dps: ({ item }) => html`
        <span>${item.dps.toFixed(2)}</span>
      `,
      costs: ({ item }) => html`
        <span>${item.costText}</span>
      `,
      def: ({ item, p }) => html`
        <span>${item[p]}</span>
      `,
    }
    const renderItemProp = (item, p) => {
      const Comp = comps[p] || comps.def
      return html`
        <${Comp} item=${item} p=${p} />
      `
    }
    const useKeys = (() => {
      /** @type {[string, boolean][]} */
      const init = [
        ['name', true],
        ['icon', true],
        ['speed', true],
        ['dps', true],
        ['armors', true],
        ['costs', false],
        ['civs', true],
      ]
      const reduce = (keys, mut) =>
        keys.map(([k, v]) =>
          k === mut.key && k !== 'name' ? [k, mut.val] : [k, v],
        )
      return () => useReducer(reduce, init)
    })()
    const [useOrderKeys, sortWithOrderKeys] = (() => {
      const init = [
        ['speed', -1],
        ['name', 1],
      ]
      const string = (q = '', w = '') =>
        q.localeCompare(w, void 0, { numeric: true })
      const number = (q = 0, w = 0) => q - w
      const comp = {
        name: string,
        icon: string,
        speed: number,
        dps: number,
        armors: string,
        costs: number,
        civs: string,
      }
      const reduce = (keys, mut) => {
        if (comp[mut]) {
          const i = keys.find(k => mut === k[0])?.[1] ?? 1
          return [[mut, -i], ...keys.filter(k => mut !== k[0])]
        }
        return keys
      }
      return [
        () => useReducer(reduce, init),
        keys => (q, w) => {
          for (const [k, i] of keys) {
            const c = comp[k](q?.[k], w?.[k])
            if (c) return i * c
          }
          return 0
        },
      ]
    })()
    const useDataSetting = (() => {
      const init = [
        ['ship', false],
        ['age<=2', true],
      ]
      const reduce = (st, mut) =>
        st.map(([k, v]) => (k === mut.key ? [k, mut.val] : [k, v]))
      return () => useReducer(reduce, init)
    })()
    const useCivs = (() => {
      const list = [
        {
          id: 'ab',
          name: 'Abbasid Dynasty',
          href: 'https://aoe4world.com/explorer/civs/abbasid',
        },
        {
          id: 'ay',
          name: 'Ayyubids',
          href: 'https://aoe4world.com/explorer/civs/ayyubids',
        },
        {
          id: 'by',
          name: 'Byzantines',
          href: 'https://aoe4world.com/explorer/civs/byzantines',
        },
        {
          id: 'ch',
          name: 'Chinese',
          href: 'https://aoe4world.com/explorer/civs/chinese',
        },
        {
          id: 'de',
          name: 'Delhi Sultanate',
          href: 'https://aoe4world.com/explorer/civs/delhi',
        },
        {
          id: 'en',
          name: 'English',
          href: 'https://aoe4world.com/explorer/civs/english',
        },
        {
          id: 'fr',
          name: 'French',
          href: 'https://aoe4world.com/explorer/civs/french',
        },
        {
          id: 'hr',
          name: 'Holy Roman Empire',
          href: 'https://aoe4world.com/explorer/civs/hre',
        },
        {
          id: 'ja',
          name: 'Japanese',
          href: 'https://aoe4world.com/explorer/civs/japanese',
        },
        {
          id: 'je',
          name: "Jeanne d'Arc",
          href: 'https://aoe4world.com/explorer/civs/jeannedarc',
        },
        {
          id: 'ma',
          name: 'Malians',
          href: 'https://aoe4world.com/explorer/civs/malians',
        },
        {
          id: 'mo',
          name: 'Mongols',
          href: 'https://aoe4world.com/explorer/civs/mongols',
        },
        {
          id: 'od',
          name: 'Order of the Dragon',
          href: 'https://aoe4world.com/explorer/civs/orderofthedragon',
        },
        {
          id: 'ot',
          name: 'Ottomans',
          href: 'https://aoe4world.com/explorer/civs/ottomans',
        },
        {
          id: 'ru',
          name: 'Rus',
          href: 'https://aoe4world.com/explorer/civs/rus',
        },
        {
          id: 'zx',
          name: "Zhu Xi's Legacy",
          href: 'https://aoe4world.com/explorer/civs/zhuxi',
        },
      ]
      const init = list.map(i => [i.id, true])
      const reduce = (st, mut) =>
        st.map(([k, v]) => (k === mut.key ? [k, mut.val] : [k, v]))
      const map = Object.entries(list.map(o => [o.id, o]))
      return () => [map, ...useReducer(reduce, init)]
    })()
    const { html, render } = htmPreact
    const { useReducer } = htmPreact
    const App = ({ data }) => {
      const [keys, setKeys] = useKeys()
      const [setlist, setset] = useDataSetting()
      const [civmap, civset, setCivset] = useCivs()
      const [orderKeys, setOrderKeys] = useOrderKeys()
      const setting = Object.fromEntries(setlist)
      const civsets = Object.fromEntries(civset)
      const list = formatData(
        data
          .filter(q => setting['ship'] || !~q.classes.indexOf('ship'))
          .filter(q => !setting['age<=2'] || q.age <= 2)
          .map(q => ({ ...q, civs: q.civs.filter(c => civsets[c]) }))
          .filter(q => q.civs.length),
      ).sort(sortWithOrderKeys(orderKeys))
      return html`
        <div>
          <p class="tools">
            ${setlist.map(
              ([k, v]) => html`
                <label key=${k}>
                  <input
                    type="checkbox"
                    checked=${v}
                    onChange=${e => setset({ key: k, val: e.target.checked })}
                  />
                  ${k}
                </label>
              `,
            )}
          </p>
          <p class="tools">
            ${civset.map(
              ([k, v]) => html`
                <label key=${k}>
                  <input
                    type="checkbox"
                    checked=${v}
                    onChange=${e =>
                      setCivset({ key: k, val: e.target.checked })}
                  />
                  ${k}
                </label>
              `,
            )}
          </p>
          <p class="tools">
            ${keys.map(
              ([k, v]) => html`
                <label key=${k}>
                  <input
                    type="checkbox"
                    checked=${v}
                    onChange=${e => setKeys({ key: k, val: e.target.checked })}
                  />
                  ${k}
                </label>
              `,
            )}
          </p>
          <table>
            <tr>
              ${keys
                .filter(([, v]) => v)
                .map(
                  ([k]) => html`
                    <th key=${k} onClick=${() => setOrderKeys(k)}>${k}</th>
                  `,
                )}
            </tr>
            ${list.map(
              item => html`
                <tr key=${item.id}>
                  ${keys
                    .filter(([, v]) => v)
                    .map(
                      ([k]) => html`
                        <td key=${k}>${renderItemProp(item, k)}</td>
                      `,
                    )}
                </tr>
              `,
            )}
          </table>
        </div>
      `
    }
    const main = async () => {
      const json = await getData()
      const list = formatData(json.data)
      console.log(list)
      globalThis.json = json
      globalThis.list = list
      const root = document.querySelector('main')
      if (root)
        render(
          html`
            <${App} data=${json.data} />
          `,
          root,
        )
    }
    Promise.resolve()
      .then(main)
      .catch(x => console.error(x))
  </script>
</html>
